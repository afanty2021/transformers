# 安装指南

<cite>
**本文档中引用的文件**
- [setup.py](file://setup.py)
- [pyproject.toml](file://pyproject.toml)
- [README.md](file://README.md)
- [tests/test_modeling_common.py](file://tests/test_modeling_common.py)
- [src/transformers/dependency_versions_check.py](file://src/transformers/dependency_versions_check.py)
- [utils/check_build.py](file://utils/check_build.py)
- [CONTRIBUTING.md](file://CONTRIBUTING.md)
- [src/transformers/cli/system.py](file://src/transformers/cli/system.py)
- [utils/print_env.py](file://utils/print_env.py)
</cite>

## 目录
1. [简介](#简介)
2. [系统要求](#系统要求)
3. [基本安装方法](#基本安装方法)
4. [高级安装选项](#高级安装选项)
5. [从源码安装](#从源码安装)
6. [环境特定安装](#环境特定安装)
7. [安装验证](#安装验证)
8. [依赖项管理](#依赖项管理)
9. [故障排除](#故障排除)
10. [最佳实践](#最佳实践)

## 简介

Transformers库是Hugging Face开发的状态领先机器学习模型框架，支持文本、计算机视觉、音频、视频和多模态任务。本指南将详细介绍如何在各种环境中安装和配置Transformers库。

Transformers库具有以下特点：
- 支持PyTorch、TensorFlow和Flax三种深度学习框架
- 提供超过100万种预训练模型检查点
- 统一的API接口，简化模型使用流程
- 跨框架兼容性，支持模型在不同框架间迁移

## 系统要求

### 基础要求
- **Python版本**: 3.10或更高版本
- **操作系统**: Linux、macOS、Windows
- **内存**: 至少4GB RAM（推荐8GB以上）
- **存储空间**: 至少2GB可用空间

### 框架要求
- **PyTorch**: 2.2或更高版本（推荐最新稳定版）
- **TensorFlow**: 2.15或更高版本（可选）
- **Flax/JAX**: 0.4.1或更高版本（可选）

### 推荐配置
- **GPU支持**: CUDA 11.8或更高版本（NVIDIA GPU）
- **CPU优化**: AVX2指令集支持
- **网络连接**: 稳定的互联网连接用于下载模型

**章节来源**
- [setup.py](file://setup.py#L430-L456)
- [README.md](file://README.md#L80-L90)

## 基本安装方法

### 使用pip安装

最简单的安装方式是使用pip包管理器：

```bash
# 安装基础版本（仅核心功能）
pip install transformers

# 安装带有PyTorch支持的版本
pip install "transformers[torch]"

# 安装带有TensorFlow支持的版本
pip install "transformers[tensorflow]"

# 安装带有Flax支持的版本
pip install "transformers[flax]"
```

### 使用uv安装（推荐）

uv是一个快速的Python包管理器，性能优于传统pip：

```bash
# 安装基础版本
uv pip install transformers

# 安装带有PyTorch支持的版本
uv pip install "transformers[torch]"
```

### 选择合适的安装变体

Transformers提供了多种安装变体以满足不同需求：

| 安装变体 | 包含组件 | 适用场景 |
|---------|---------|---------|
| `transformers` | 核心功能 | 基础使用，最小依赖 |
| `transformers[torch]` | PyTorch支持 | PyTorch项目 |
| `transformers[torch-speech]` | 语音处理 | 音频相关任务 |
| `transformers[torch-vision]` | 计算机视觉 | 图像处理任务 |
| `transformers[vision]` | 基础视觉 | 图像分类等任务 |
| `transformers[serving]` | 模型服务 | 生产部署 |
| `transformers[all]` | 所有功能 | 完整功能体验 |

**章节来源**
- [setup.py](file://setup.py#L200-L350)
- [README.md](file://README.md#L95-L110)

## 高级安装选项

### 开发者安装

对于希望参与贡献或使用最新功能的开发者：

```bash
# 克隆仓库
git clone https://github.com/huggingface/transformers.git
cd transformers

# 开发模式安装
pip install -e ".[dev]"

# 或者安装所有功能
pip install -e ".[all]"
```

### 特定功能安装

根据具体需求安装特定功能模块：

```bash
# 自然语言处理功能
pip install "transformers[torch,sentencepiece,tokenizers]"

# 多模态功能
pip install "transformers[torch,vision,audio]"

# 高性能推理
pip install "transformers[torch,serving,accelerate]"

# 分布式训练
pip install "transformers[torch,deepspeed,accelerate]"
```

### 条件安装

基于现有环境条件进行智能安装：

```bash
# 检查环境并安装相应版本
python -c "import transformers; transformers.check_env()"
```

**章节来源**
- [setup.py](file://setup.py#L350-L400)
- [CONTRIBUTING.md](file://CONTRIBUTING.md#L1-L50)

## 从源码安装

### 克隆仓库

```bash
# 克隆主分支
git clone https://github.com/huggingface/transformers.git
cd transformers

# 或克隆特定版本
git clone -b v4.38.0 https://github.com/huggingface/transformers.git
cd transformers
```

### 安装依赖

```bash
# 更新pip到最新版本
pip install --upgrade pip

# 安装开发依赖
pip install -r requirements.txt

# 安装构建工具
pip install build
```

### 构建和安装

```bash
# 清理之前的构建
rm -rf build/ dist/ *.egg-info/

# 构建源码包
python -m build

# 安装到系统
pip install .

# 或开发模式安装
pip install -e .
```

### 验证构建

```bash
# 运行构建验证
python utils/check_build.py --check_lib

# 检查自定义文件是否存在
python utils/check_build.py
```

### Docker安装

使用官方Docker镜像：

```bash
# 基础镜像
docker pull huggingface/transformers:latest

# GPU支持镜像
docker pull huggingface/transformers:latest-gpu

# 运行容器
docker run --gpus all -it huggingface/transformers:latest bash
```

**章节来源**
- [utils/check_build.py](file://utils/check_build.py#L1-L50)
- [README.md](file://README.md#L115-L130)

## 环境特定安装

### Linux环境

#### Ubuntu/Debian系统

```bash
# 更新包管理器
sudo apt update
sudo apt upgrade

# 安装Python和pip
sudo apt install python3 python3-pip python3-venv

# 创建虚拟环境
python3 -m venv transformers-env
source transformers-env/bin/activate

# 安装Transformers
pip install "transformers[torch]"
```

#### CentOS/RHEL系统

```bash
# 启用EPEL仓库
sudo yum install epel-release

# 安装Python 3
sudo yum install python3 python3-pip python3-virtualenv

# 创建虚拟环境
python3 -m venv transformers-env
source transformers-env/bin/activate

# 安装Transformers
pip install "transformers[torch]"
```

### macOS环境

#### 使用Homebrew

```bash
# 安装Homebrew（如果未安装）
/bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"

# 安装Python
brew install python

# 创建虚拟环境
python3 -m venv transformers-env
source transformers-env/bin/activate

# 安装Transformers
pip install "transformers[torch]"
```

#### Apple Silicon（M1/M2/M3）

```bash
# 安装Rosetta 2（如果需要）
softwareupdate --install-rosetta

# 安装Python
brew install python

# 设置环境变量
export PYTORCH_ENABLE_MPS_FALLBACK=1
export PYTORCH_MPS_HIGH_WATERMARK_RATIO=0.0

# 安装Transformers
pip install "transformers[torch]"
```

### Windows环境

#### 使用PowerShell

```powershell
# 创建虚拟环境
python -m venv transformers-env
.\transformers-env\Scripts\Activate

# 升级pip
pip install --upgrade pip

# 安装Transformers
pip install "transformers[torch]"
```

#### 使用Anaconda

```bash
# 创建Conda环境
conda create -n transformers python=3.10
conda activate transformers

# 从conda-forge安装
conda install -c conda-forge transformers

# 或从PyPI安装
pip install "transformers[torch]"
```

#### Windows特殊注意事项

1. **开发工具**: 安装Visual Studio Build Tools
2. **缓存优化**: 启用开发模式以利用缓存优势
3. **路径长度**: 注意Windows路径长度限制（260字符）

**章节来源**
- [README.md](file://README.md#L80-L110)
- [src/transformers/cli/system.py](file://src/transformers/cli/system.py#L50-L100)

## 安装验证

### 基础验证

创建验证脚本：

```python
# verify_installation.py
import transformers
import torch
import sys

print(f"Transformers version: {transformers.__version__}")
print(f"Python version: {sys.version}")
print(f"PyTorch version: {torch.__version__}")

# 测试基本功能
try:
    from transformers import pipeline
    print("✓ Transformers导入成功")
    
    # 测试文本分类管道
    classifier = pipeline("text-classification")
    result = classifier("我喜欢使用Transformers库！")
    print(f"✓ 文本分类功能正常: {result}")
    
except Exception as e:
    print(f"✗ 安装验证失败: {e}")
```

运行验证：
```bash
python verify_installation.py
```

### 环境信息收集

使用内置命令收集环境信息：

```bash
# 显示完整环境信息
transformers env

# 显示版本信息
transformers version
```

### 功能测试

```python
# comprehensive_test.py
import transformers
import torch
from transformers import AutoTokenizer, AutoModel

def test_basic_functionality():
    """测试基本功能"""
    print("测试基本功能...")
    
    # 检查版本
    assert transformers.__version__ is not None
    
    # 检查PyTorch
    if torch.cuda.is_available():
        print(f"CUDA可用: {torch.cuda.get_device_name()}")
    else:
        print("CUDA不可用")
    
    print("基本功能测试通过")

def test_model_loading():
    """测试模型加载"""
    print("测试模型加载...")
    
    try:
        tokenizer = AutoTokenizer.from_pretrained("distilbert-base-uncased")
        model = AutoModel.from_pretrained("distilbert-base-uncased")
        print("✓ 模型加载成功")
    except Exception as e:
        print(f"✗ 模型加载失败: {e}")

if __name__ == "__main__":
    test_basic_functionality()
    test_model_loading()
    print("所有测试完成！")
```

### 性能基准测试

```python
# performance_test.py
import time
import torch
from transformers import pipeline

def benchmark_inference():
    """基准测试推理性能"""
    print("开始性能基准测试...")
    
    # 初始化管道
    pipe = pipeline("text-generation", model="distilgpt2", device=0 if torch.cuda.is_available() else -1)
    
    # 测试推理
    texts = ["这是一个性能测试", "Transformer库非常强大", "让我们测试一下响应时间"]
    
    start_time = time.time()
    results = pipe(texts, max_length=50, num_return_sequences=1)
    end_time = time.time()
    
    avg_time = (end_time - start_time) / len(texts)
    print(f"平均推理时间: {avg_time:.3f}秒")
    print(f"吞吐量: {len(texts)/avg_time:.2f}次/秒")

if __name__ == "__main__":
    benchmark_inference()
```

**章节来源**
- [tests/test_modeling_common.py](file://tests/test_modeling_common.py#L1-L100)
- [src/transformers/dependency_versions_check.py](file://src/transformers/dependency_versions_check.py#L1-L64)

## 依赖项管理

### setup.py配置

Transformers使用传统的setup.py配置文件来管理依赖项：

```python
# 关键依赖项列表
install_requires = [
    "filelock",           # 文件系统锁
    "huggingface-hub",    # Hugging Face Hub客户端
    "numpy",              # 数值计算
    "packaging",          # 版本比较
    "pyyaml",             # YAML配置
    "regex",              # 正则表达式
    "requests",           # HTTP请求
    "tokenizers",         # 分词器
    "safetensors",        # 安全张量
    "tqdm",               # 进度条
]
```

### pyproject.toml配置

现代Python项目使用pyproject.toml进行配置：

```toml
[tool.ruff]
target-version = "py310"
line-length = 119

[tool.pytest.ini_options]
addopts = "--doctest-glob='**/*.md'"
doctest_optionflags="NUMBER NORMALIZE_WHITESPACE ELLIPSIS"
```

### 可选依赖项

Transformers提供了丰富的可选依赖项集合：

| 依赖组 | 包列表 | 用途 |
|-------|--------|------|
| `torch` | torch, accelerate | PyTorch支持 |
| `vision` | Pillow | 图像处理 |
| `audio` | librosa, torchaudio | 音频处理 |
| `speech` | torchaudio, phonemizer | 语音识别 |
| `integrations` | deepspeed, ray | 分布式训练 |
| `testing` | pytest系列 | 测试框架 |

### 依赖版本检查

运行时依赖版本检查机制：

```python
# 自动检查关键依赖版本
pkgs_to_check_at_runtime = [
    "python", "tqdm", "regex", "requests",
    "packaging", "filelock", "numpy", "tokenizers",
    "huggingface-hub", "safetensors", "accelerate"
]
```

### 依赖更新机制

```bash
# 更新依赖表
python setup.py deps_table_update

# 检查依赖版本
python -c "from transformers.dependency_versions_table import deps; print(deps['torch'])"
```

**章节来源**
- [setup.py](file://setup.py#L80-L200)
- [pyproject.toml](file://pyproject.toml#L1-L74)
- [src/transformers/dependency_versions_check.py](file://src/transformers/dependency_versions_check.py#L20-L64)

## 故障排除

### 常见安装问题

#### 1. Python版本不兼容

**问题**: `ERROR: transformers requires Python >= 3.10`

**解决方案**:
```bash
# 检查Python版本
python --version

# 升级到Python 3.10+
# Ubuntu/Debian
sudo apt install python3.10

# macOS
brew install python@3.10
```

#### 2. pip版本过旧

**问题**: `ERROR: This package requires pip >= 23.1`

**解决方案**:
```bash
# 升级pip
pip install --upgrade pip

# 或使用get-pip.py
curl https://bootstrap.pypa.io/get-pip.py -o get-pip.py
python get-pip.py
```

#### 3. 内存不足错误

**问题**: `ERROR: Could not install packages due to an EnvironmentError: [Errno 12] Cannot allocate memory`

**解决方案**:
```bash
# 增加swap空间
sudo fallocate -l 4G /swapfile
sudo chmod 600 /swapfile
sudo mkswap /swapfile
sudo swapon /swapfile

# 或使用较小的安装
pip install transformers --no-cache-dir
```

#### 4. 网络连接问题

**问题**: `ERROR: Could not find a version that satisfies the requirement transformers`

**解决方案**:
```bash
# 使用国内镜像源
pip install transformers -i https://pypi.tuna.tsinghua.edu.cn/simple

# 或设置代理
pip install transformers --proxy http://proxy.server:port
```

### 框架相关问题

#### PyTorch安装问题

**问题**: `ModuleNotFoundError: No module named 'torch'`

**解决方案**:
```bash
# 检查CUDA版本
nvcc --version

# 安装对应CUDA版本的PyTorch
pip install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cu118

# CPU版本
pip install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cpu
```

#### TensorFlow安装问题

**问题**: `ImportError: cannot import name 'tf'`

**解决方案**:
```bash
# 检查TensorFlow安装
pip show tensorflow

# 重新安装
pip uninstall tensorflow
pip install tensorflow

# 或使用GPU版本
pip install tensorflow-gpu
```

### 平台特定问题

#### Windows问题

**问题**: `Microsoft Visual C++ 14.0 is required`

**解决方案**:
1. 安装[Visual Studio Build Tools](https://visualstudio.microsoft.com/downloads/#build-tools-for-visual-studio-2022)
2. 或使用预编译wheel：
```bash
pip install transformers --only-binary=all
```

#### macOS问题

**问题**: `Library not loaded: @rpath/libomp.dylib`

**解决方案**:
```bash
# 安装OpenMP
brew install libomp

# 设置环境变量
export DYLD_LIBRARY_PATH=/usr/local/opt/libomp/lib:$DYLD_LIBRARY_PATH
```

### 调试工具

使用内置调试工具：

```bash
# 显示详细环境信息
transformers env

# 检查安装状态
python -c "import transformers; transformers.check_install()"
```

创建诊断脚本：

```python
# diagnose.py
import sys
import subprocess

def check_python():
    """检查Python环境"""
    print(f"Python版本: {sys.version}")
    print(f"Python路径: {sys.executable}")

def check_pip():
    """检查pip版本"""
    result = subprocess.run(["pip", "--version"], capture_output=True, text=True)
    print(f"Pip版本: {result.stdout.strip()}")

def check_transformers():
    """检查Transformers安装"""
    try:
        import transformers
        print(f"Transformers版本: {transformers.__version__}")
        
        # 检查关键依赖
        deps = ['torch', 'tensorflow', 'jax', 'flax']
        for dep in deps:
            try:
                __import__(dep)
                print(f"✓ {dep} 已安装")
            except ImportError:
                print(f"✗ {dep} 未安装")
                
    except ImportError as e:
        print(f"✗ Transformers导入失败: {e}")

if __name__ == "__main__":
    check_python()
    check_pip()
    check_transformers()
```

**章节来源**
- [src/transformers/cli/system.py](file://src/transformers/cli/system.py#L50-L137)
- [utils/print_env.py](file://utils/print_env.py#L1-L43)

## 最佳实践

### 环境管理

#### 使用虚拟环境

```bash
# 创建虚拟环境
python -m venv transformers-env
source transformers-env/bin/activate  # Linux/macOS
# 或
.\transformers-env\Scripts\activate  # Windows

# 在虚拟环境中安装
pip install "transformers[torch]"
```

#### 使用conda环境

```bash
# 创建conda环境
conda create -n transformers python=3.10
conda activate transformers

# 安装Transformers
conda install -c conda-forge transformers
```

#### 使用poetry管理依赖

```bash
# 初始化poetry项目
poetry init

# 添加Transformers
poetry add "transformers[torch]"

# 激活环境
poetry shell
```

### 版本控制

#### 锁定版本

```bash
# 创建requirements.txt
pip freeze > requirements.txt

# 指定版本安装
pip install -r requirements.txt
```

#### 使用pip-tools

```bash
# 安装pip-tools
pip install pip-tools

# 编辑requirements.in
echo "transformers[torch]==4.38.0" > requirements.in

# 生成requirements.txt
pip-compile requirements.in

# 安装
pip install -r requirements.txt
```

### 性能优化

#### GPU加速

```python
# 检查GPU可用性
import torch
if torch.cuda.is_available():
    device = torch.device("cuda")
    print(f"使用GPU: {torch.cuda.get_device_name()}")
else:
    device = torch.device("cpu")
    print("使用CPU")

# 设置设备
model.to(device)
```

#### 内存优化

```python
# 使用半精度
model = model.half()

# 使用梯度检查点
model.gradient_checkpointing_enable()

# 清理GPU内存
torch.cuda.empty_cache()
```

### 安全考虑

#### 验证安装

```bash
# 验证pip包完整性
pip install --trusted-host pypi.org --trusted-host files.pythonhosted.org transformers

# 检查包签名（如果可用）
pip install transformers --require-hashes
```

#### 定期更新

```bash
# 检查更新
pip list --outdated

# 更新Transformers
pip install --upgrade transformers

# 更新所有包
pip list --outdated --format=freeze | grep -v '^\-e' | cut -d = -f 1  | xargs -n1 pip install -U
```

### 开发工作流

#### 测试集成

```python
# pytest配置
# pytest.ini
[pytest]
addopts = --doctest-glob='**/*.md'
doctest_optionflags=NUMBER NORMALIZE_WHITESPACE ELLIPSIS
```

#### 持续集成

```yaml
# .github/workflows/test.yml
name: Test
on: [push, pull_request]
jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Set up Python
        uses: actions/setup-python@v2
        with:
          python-version: '3.10'
      - name: Install dependencies
        run: |
          pip install -e ".[dev]"
      - name: Run tests
        run: |
          pytest tests/
```

### 生产部署

#### Docker化应用

```dockerfile
# Dockerfile
FROM python:3.10-slim

WORKDIR /app

# 安装系统依赖
RUN apt-get update && apt-get install -y \
    gcc \
    && rm -rf /var/lib/apt/lists/*

# 复制项目文件
COPY requirements.txt .
COPY src ./src

# 安装Python依赖
RUN pip install --no-cache-dir -r requirements.txt

# 复制应用代码
COPY app.py .

# 运行应用
CMD ["python", "app.py"]
```

#### Kubernetes部署

```yaml
# deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: transformers-app
spec:
  replicas: 3
  selector:
    matchLabels:
      app: transformers
  template:
    metadata:
      labels:
        app: transformers
    spec:
      containers:
      - name: transformers
        image: transformers-app:latest
        resources:
          requests:
            memory: "2Gi"
            cpu: "1"
          limits:
            memory: "4Gi"
            cpu: "2"
        env:
        - name: CUDA_VISIBLE_DEVICES
          value: "0,1"
```

**章节来源**
- [CONTRIBUTING.md](file://CONTRIBUTING.md#L1-L100)
- [README.md](file://README.md#L1-L50)