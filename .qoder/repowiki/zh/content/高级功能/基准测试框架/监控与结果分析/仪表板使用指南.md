# 仪表板使用指南

<cite>
**本文档中引用的文件**
- [grafana_dashboard.json](file://benchmark/grafana_dashboard.json)
- [continuous-batching-dashboard.json](file://examples/metrics-monitoring/continuous-batching-dashboard.json)
- [grafana_datasource.yaml](file://benchmark/grafana_datasource.yaml)
- [grafana-dashboard.yaml](file://examples/metrics-monitoring/grafana-dashboard.yaml)
- [docker-compose.yml](file://examples/metrics-monitoring/docker-compose.yml)
- [prometheus.yml](file://examples/metrics-monitoring/prometheus.yml)
- [grafana-datasources.yaml](file://examples/metrics-monitoring/grafana-datasources.yaml)
- [tempo.yaml](file://examples/metrics-monitoring/tempo.yaml)
- [README.md](file://benchmark/README.md)
- [README.md](file://examples/metrics-monitoring/README.md)
</cite>

## 目录
1. [简介](#简介)
2. [项目结构概览](#项目结构概览)
3. [核心仪表板分析](#核心仪表板分析)
4. [Grafana仪表板架构](#grafana仪表板架构)
5. [详细仪表板配置](#详细仪表板配置)
6. [数据源配置](#数据源配置)
7. [部署和启动](#部署和启动)
8. [高级功能配置](#高级功能配置)
9. [监控最佳实践](#监控最佳实践)
10. [故障排除指南](#故障排除指南)
11. [总结](#总结)

## 简介

本指南详细介绍了transformers项目中Grafana仪表板的配置和使用方法。项目包含两个主要的监控仪表板：用于基准测试的`grafana_dashboard.json`和用于连续批处理的`continuous-batching-dashboard.json`。这些仪表板提供了全面的模型推理性能和系统资源监控能力。

## 项目结构概览

transformers项目中的监控和仪表板配置主要分布在以下目录结构中：

```mermaid
graph TB
subgraph "基准测试监控"
A[benchmark/] --> B[grafana_dashboard.json]
A --> C[grafana_datasource.yaml]
A --> D[README.md]
end
subgraph "连续批处理监控"
E[examples/metrics-monitoring/] --> F[continuous-batching-dashboard.json]
E --> G[docker-compose.yml]
E --> H[prometheus.yml]
E --> I[tempo.yaml]
E --> J[README.md]
end
subgraph "数据源配置"
K[grafana-datasources.yaml]
L[grafana-dashboard.yaml]
end
B --> K
F --> K
G --> L
```

**图表来源**
- [benchmark/grafana_dashboard.json](file://benchmark/grafana_dashboard.json#L1-L50)
- [examples/metrics-monitoring/continuous-batching-dashboard.json](file://examples/metrics-monitoring/continuous-batching-dashboard.json#L1-L50)

## 核心仪表板分析

### 基准测试仪表板 (grafana_dashboard.json)

基准测试仪表板专注于模型推理性能的详细监控，包含以下关键面板：

#### 面板布局结构

```mermaid
graph LR
subgraph "性能指标面板"
A[首次前向传播<br/>First eager forward pass]
B[第二次前向传播<br/>Second eager forward pass]
C[首次Token时间<br/>Time to first token]
D[第二次Token时间<br/>Time to second token]
E[第三次Token时间<br/>Time to third token]
F[后续Token平均时间<br/>Time to subsequent next tokens mean]
end
subgraph "编译生成面板"
G[首次编译生成<br/>First compile generate]
H[第二次编译生成<br/>Second compile generate]
I[第三次编译生成<br/>Third compile generate]
J[第四次编译生成<br/>Fourth compile generate]
end
subgraph "系统资源面板"
K[CPU利用率<br/>CPU Utilization]
L[GPU利用率<br/>GPU Utilization]
M[内存使用量<br/>Memory usage]
N[GPU内存使用量<br/>GPU memory usage]
end
```

**图表来源**
- [benchmark/grafana_dashboard.json](file://benchmark/grafana_dashboard.json#L64-L200)

#### 关键查询语句分析

仪表板使用PostgreSQL数据源执行以下核心查询：

1. **性能指标查询**：
   ```sql
   SELECT CAST(m.measurements->'first_eager_forward_pass_time_secs' AS double precision) 
   FROM benchmarks as b JOIN model_measurements AS m ON b.benchmark_id = m.benchmark_id
   ```

2. **系统资源查询**：
   ```sql
   SELECT d.cpu_util, d.time 
   FROM benchmarks AS b JOIN device_measurements AS d ON b.benchmark_id = d.benchmark_id
   ```

**节来源**
- [benchmark/grafana_dashboard.json](file://benchmark/grafana_dashboard.json#L64-L2376)

### 连续批处理仪表板 (continuous-batching-dashboard.json)

连续批处理仪表板专门用于监控实时推理系统的性能指标：

#### 面板配置概览

```mermaid
graph TB
subgraph "核心指标面板"
A[KV缓存内存使用<br/>KV Cache Memory Usage]
B[活跃请求数量<br/>Active Requests]
C[等待请求数量<br/>Waiting Requests]
D[解码/预填充比率<br/>Decode/Prefill Ratio]
end
subgraph "吞吐量面板"
E[解码Token速率<br/>Decode tokens throughput tok/s]
F[预填充Token速率<br/>Prefill rate tok/s]
end
subgraph "性能分布面板"
G[批次填充百分比分位数<br/>Batch fill percentage percentiles]
H[KV缓存内存使用趋势<br/>KV Cache Memory Usage Over Time]
end
subgraph "延迟指标面板"
I[TTFT延迟分布<br/>Time to First Token Distribution]
J[Token处理延迟<br/>Token Processing Latency]
end
```

**图表来源**
- [examples/metrics-monitoring/continuous-batching-dashboard.json](file://examples/metrics-monitoring/continuous-batching-dashboard.json#L1-L100)

**节来源**
- [examples/metrics-monitoring/continuous-batching-dashboard.json](file://examples/metrics-monitoring/continuous-batching-dashboard.json#L1-L974)

## Grafana仪表板架构

### 数据流架构

```mermaid
sequenceDiagram
participant App as 应用程序
participant OTEL as OpenTelemetry SDK
participant Prometheus as Prometheus
participant Tempo as Tempo
participant Grafana as Grafana
participant Dashboard as 仪表板
App->>OTEL : 记录指标和追踪
OTEL->>Prometheus : 导出指标数据
OTEL->>Tempo : 导出追踪数据
Grafana->>Prometheus : 查询指标数据
Grafana->>Tempo : 查询追踪数据
Prometheus-->>Grafana : 返回指标数据
Tempo-->>Grafana : 返回追踪数据
Grafana->>Dashboard : 渲染可视化
Dashboard-->>App : 显示监控结果
```

**图表来源**
- [docker-compose.yml](file://examples/metrics-monitoring/docker-compose.yml#L1-L56)
- [prometheus.yml](file://examples/metrics-monitoring/prometheus.yml#L1-L4)

### 变量和模板配置

仪表板支持多个动态变量，允许用户自定义监控视图：

| 变量名称 | 类型 | 描述 | 默认值 |
|---------|------|------|--------|
| branch | 查询变量 | Git分支选择 | main |
| gpu_name | 查询变量 | GPU型号选择 | NVIDIA A10G |
| last_n_commits | 文本框 | 显示的提交数量 | 10 |
| StartTime | 查询变量 | 开始时间 | 自动计算 |
| EndTime | 查询变量 | 结束时间 | 自动计算 |

**节来源**
- [benchmark/grafana_dashboard.json](file://benchmark/grafana_dashboard.json#L2259-L2376)

## 详细仪表板配置

### 基准测试仪表板配置

#### 面板配置详解

每个性能指标面板都采用统一的配置模式：

```mermaid
flowchart TD
A[数据查询] --> B[数据转换]
B --> C[可视化渲染]
C --> D[阈值检查]
D --> E[颜色映射]
A1[PostgreSQL查询] --> A
B1[排序转换] --> B
C1[柱状图渲染] --> C
D1[阈值配置] --> D
E1[连续色带] --> E
```

**图表来源**
- [benchmark/grafana_dashboard.json](file://benchmark/grafana_dashboard.json#L64-L200)

#### 性能指标面板配置

1. **首次前向传播时间**
   - 数据源：PostgreSQL
   - 查询字段：`first_eager_forward_pass_time_secs`
   - 单位：秒
   - 可视化类型：柱状图
   - 颜色映射：连续YlBl色带

2. **时间到首个Token**
   - 数据源：PostgreSQL
   - 查询字段：`time_to_first_token_secs`
   - 单位：秒
   - 可视化类型：柱状图
   - 阈值设置：绿色表示正常，红色表示异常

**节来源**
- [benchmark/grafana_dashboard.json](file://benchmark/grafana_dashboard.json#L150-L400)

### 连续批处理仪表板配置

#### 核心指标面板配置

```mermaid
graph LR
subgraph "KV缓存监控"
A[内存使用量<br/>kv_cache_memory_bytes]
B[空闲内存<br/>kv_cache_free_memory_bytes]
end
subgraph "请求监控"
C[活跃请求数<br/>active_requests_count]
D[等待请求数<br/>waiting_requests_count]
end
subgraph "性能监控"
E[解码Token速率<br/>decode_tokens_processed_total]
F[预填充Token速率<br/>prefill_tokens_processed_total]
end
A --> G[内存使用率仪表盘]
C --> H[请求队列状态]
E --> I[吞吐量监控]
```

**图表来源**
- [examples/metrics-monitoring/continuous-batching-dashboard.json](file://examples/metrics-monitoring/continuous-batching-dashboard.json#L50-L200)

#### Prometheus查询配置

连续批处理仪表板使用Prometheus作为数据源，配置以下关键查询：

1. **内存使用监控**：
   ```promql
   kv_cache_memory_bytes
   ```

2. **请求计数监控**：
   ```promql
   active_requests_count
   waiting_requests_count
   ```

3. **Token处理速率**：
   ```promql
   rate(decode_tokens_processed_total[$__rate_interval])
   rate(prefill_tokens_processed_total[$__rate_interval])
   ```

**节来源**
- [examples/metrics-monitoring/continuous-batching-dashboard.json](file://examples/metrics-monitoring/continuous-batching-dashboard.json#L50-L300)

## 数据源配置

### PostgreSQL数据源配置

基准测试仪表板使用PostgreSQL作为主要数据源：

```yaml
datasources:
  - name: grafana-postgresql-datasource
    uid: be28nkzirtb0gd
    type: postgres
    url: $GRAFANA_POSTGRES_DATASOURCE_URL
    user: $GRAFANA_POSTGRES_DATASOURCE_USER
    secureJsonData:
      password: $GRAFANA_POSTGRES_DATASOURCE_PWD
    jsonData:
      database: metrics
      maxOpenConns: 100
      maxIdleConns: 100
      postgresVersion: 1000
      timescaledb: false
```

#### 环境变量配置

| 环境变量 | 描述 | 示例值 |
|---------|------|--------|
| GRAFANA_POSTGRES_DATASOURCE_URL | 数据库连接URL | postgres://localhost:5432 |
| GRAFANA_POSTGRES_DATASOURCE_USER | 数据库用户名 | grafana_user |
| GRAFANA_POSTGRES_DATASOURCE_PWD | 数据库密码 | secure_password |

**节来源**
- [benchmark/grafana_datasource.yaml](file://benchmark/grafana_datasource.yaml#L1-L18)

### Prometheus数据源配置

连续批处理仪表板使用Prometheus进行时序数据监控：

```yaml
datasources:
  - name: Prometheus
    type: prometheus
    access: proxy
    url: http://prometheus:9090
    isDefault: true
    
  - name: Tempo
    type: tempo
    access: proxy
    url: http://tempo:3200
    uid: tempo
```

**节来源**
- [examples/metrics-monitoring/grafana-datasources.yaml](file://examples/metrics-monitoring/grafana-datasources.yaml#L1-L15)

## 部署和启动

### 完整部署流程

#### 1. 环境准备

```bash
# 克隆项目
git clone https://github.com/huggingface/transformers.git
cd transformers/examples/metrics-monitoring

# 检查Docker环境
docker --version
docker-compose --version
```

#### 2. 启动监控服务

```bash
# 使用Docker Compose启动所有服务
docker compose up -d

# 查看服务状态
docker compose ps

# 查看日志输出
docker compose logs -f grafana
```

#### 3. 仪表板导入配置

```mermaid
flowchart TD
A[Docker Compose启动] --> B[服务初始化]
B --> C[数据源注册]
C --> D[仪表板加载]
D --> E[Grafana可用]
B1[Prometheus启动] --> B
B2[Tempo启动] --> B
B3[Grafana启动] --> B
C1[PostgreSQL数据源] --> C
C2[Prometheus数据源] --> C
C3[Tempo数据源] --> C
D1[基准测试仪表板] --> D
D2[连续批处理仪表板] --> D
```

**图表来源**
- [docker-compose.yml](file://examples/metrics-monitoring/docker-compose.yml#L1-L56)

#### 4. 初始访问配置

- **Grafana访问地址**：http://localhost:3000
- **默认登录凭据**：
  - 用户名：admin
  - 密码：admin
- **数据源验证**：确保PostgreSQL、Prometheus和Tempo连接正常

**节来源**
- [docker-compose.yml](file://examples/metrics-monitoring/docker-compose.yml#L30-L56)

### 手动仪表板导入

如果需要手动导入仪表板：

1. **访问Grafana界面**
   ```
   http://localhost:3000
   ```

2. **导入基准测试仪表板**
   - 路径：`/etc/grafana/provisioning/dashboards/continuous-batching-dashboard.json`
   - 提供者：Transformers Dashboards

3. **配置数据源**
   - 添加PostgreSQL数据源（基准测试）
   - 添加Prometheus数据源（连续批处理）

## 高级功能配置

### 时间范围选择

仪表板支持灵活的时间范围配置：

```mermaid
graph LR
A[时间选择器] --> B[预设范围]
A --> C[自定义范围]
A --> D[实时刷新]
B1[最近1小时] --> B
B2[最近6小时] --> B
B3[最近24小时] --> B
B4[最近7天] --> B
C1[开始时间] --> C
C2[结束时间] --> C
D1[自动刷新] --> D
D2[Live模式] --> D
```

#### 时间范围配置选项

| 配置项 | 默认值 | 描述 |
|-------|--------|------|
| 时间范围 | now-1h | 显示最近1小时的数据 |
| 实时刷新 | 启用 | 自动更新最新数据 |
| Live模式 | 启用 | 实时显示最新指标 |

### 变量过滤配置

#### 分支过滤器

```yaml
{
  "current": {
    "selected": false,
    "text": "main",
    "value": "main"
  },
  "definition": "SELECT DISTINCT branch FROM benchmarks;",
  "label": "branch",
  "multi": false,
  "name": "branch",
  "type": "query"
}
```

#### GPU型号过滤器

```yaml
{
  "current": {
    "selected": false,
    "text": "NVIDIA A10G",
    "value": "NVIDIA A10G"
  },
  "definition": "SELECT DISTINCT metadata->>'gpu_name' FROM benchmarks;",
  "label": "GPU",
  "multi": false,
  "name": "gpu_name",
  "type": "query"
}
```

### 告警设置配置

#### 性能阈值告警

```mermaid
flowchart TD
A[性能指标监控] --> B{阈值检查}
B --> |正常| C[绿色显示]
B --> |警告| D[黄色显示]
B --> |严重| E[红色显示]
C1[< 1.0秒] --> C
D1[1.0-2.0秒] --> D
E1[> 2.0秒] --> E
F[内存使用率] --> B
G[GPU利用率] --> B
H[延迟指标] --> B
```

#### 内存使用告警配置

对于KV缓存内存使用，配置如下阈值：

| 阈值级别 | 使用量 | 颜色 | 建议操作 |
|---------|--------|------|----------|
| 正常 | < 5GB | 绿色 | 继续监控 |
| 警告 | 5-8GB | 黄色 | 检查内存使用 |
| 严重 | > 8GB | 红色 | 立即优化 |

### 自定义仪表板

#### 添加新面板

1. **创建新面板**
   - 点击"新建面板"按钮
   - 选择数据源（PostgreSQL或Prometheus）
   - 配置查询语句

2. **面板配置示例**
   ```json
   {
     "title": "自定义性能指标",
     "type": "timeseries",
     "datasource": "Prometheus",
     "targets": [
       {
         "expr": "custom_metric_name",
         "legendFormat": "{{instance}}"
       }
     ]
   }
   ```

#### 修改现有面板

1. **编辑面板**
   - 点击面板标题
   - 选择"编辑"模式
   - 修改查询或可视化设置

2. **保存更改**
   - 点击"应用"按钮
   - 保存仪表板

## 监控最佳实践

### 性能监控策略

#### 1. 关键性能指标(KPI)监控

```mermaid
graph TB
subgraph "推理性能指标"
A[首Token时间<br/>TTFB]
B[Token生成速度<br/>TPS]
C[内存使用效率<br/>Memory Efficiency]
D[GPU利用率<br/>GPU Utilization]
end
subgraph "系统稳定性指标"
E[错误率<br/>Error Rate]
F[响应时间<br/>Response Time]
G[并发处理能力<br/>Concurrency]
H[资源瓶颈<br/>Resource Bottlenecks]
end
A --> I[用户体验]
B --> I
C --> J[成本优化]
D --> J
E --> K[服务质量]
F --> K
G --> L[系统容量]
H --> L
```

#### 2. 监控频率建议

| 指标类型 | 监控频率 | 告警阈值 | 处理建议 |
|---------|---------|---------|----------|
| 实时性能 | 1秒 | TTFB > 2秒 | 立即调查 |
| 系统资源 | 15秒 | CPU > 80% | 优化负载 |
| 内存使用 | 30秒 | 内存 > 90% | 清理缓存 |
| 错误率 | 1分钟 | 错误率 > 5% | 检查服务状态 |

### 故障诊断流程

#### 1. 性能下降诊断

```mermaid
flowchart TD
A[性能指标异常] --> B{检查延迟指标}
B --> |TTFB增加| C[检查模型加载]
B --> |TPS下降| D[检查资源限制]
B --> |内存增长| E[检查内存泄漏]
C --> F[验证模型文件]
D --> G[检查GPU/CPU使用]
E --> H[检查缓存清理]
F --> I[优化模型加载]
G --> J[扩展资源]
H --> K[修复内存泄漏]
```

#### 2. 系统故障排查

1. **检查数据源连接**
   - 验证PostgreSQL连接
   - 检查Prometheus抓取状态
   - 确认Tempo追踪服务

2. **验证仪表板配置**
   - 检查变量定义
   - 验证查询语法
   - 确认权限设置

3. **监控告警配置**
   - 设置合理的阈值
   - 配置通知渠道
   - 测试告警机制

### 成本优化建议

#### 1. 资源使用优化

```mermaid
graph LR
A[资源监控] --> B[使用分析]
B --> C[优化策略]
A1[GPU利用率] --> A
A2[内存使用率] --> A
A3[存储空间] --> A
B1[峰值使用] --> B
B2[平均使用] --> B
B3[空闲时间] --> B
C1[自动扩缩容] --> C
C2[资源池管理] --> C
C3[成本监控] --> C
```

#### 2. 监控成本控制

| 优化措施 | 预期效果 | 实施难度 |
|---------|---------|---------|
| 数据保留策略 | 减少存储成本 | 中等 |
| 查询优化 | 降低计算开销 | 高 |
| 资源池共享 | 提高资源利用率 | 高 |
| 告警去重 | 减少通知成本 | 低 |

## 故障排除指南

### 常见问题及解决方案

#### 1. 数据源连接问题

**问题症状**：
- 仪表板显示"无数据"
- 查询超时错误
- 连接拒绝

**解决方案**：

```mermaid
flowchart TD
A[连接问题] --> B{检查网络连通性}
B --> |网络正常| C{检查服务状态}
B --> |网络异常| D[修复网络配置]
C --> |服务运行| E{检查认证信息}
C --> |服务未运行| F[启动服务]
E --> |认证正确| G{检查端口配置}
E --> |认证错误| H[更新认证信息]
G --> |端口正确| I[检查防火墙]
G --> |端口错误| J[修正端口配置]
```

#### 2. 查询性能问题

**问题症状**：
- 仪表板加载缓慢
- 查询超时
- 内存不足

**解决方案**：

1. **优化查询语句**
   ```sql
   -- 优化前：全表扫描
   SELECT * FROM benchmarks WHERE branch = 'main';
   
   -- 优化后：添加索引
   CREATE INDEX idx_benchmarks_branch ON benchmarks(branch);
   SELECT * FROM benchmarks WHERE branch = 'main';
   ```

2. **调整查询参数**
   - 限制返回记录数
   - 使用时间范围过滤
   - 优化JOIN条件

#### 3. 仪表板显示问题

**问题症状**：
- 图表显示异常
- 数据格式错误
- 布局错乱

**解决方案**：

1. **检查数据格式**
   - 验证数值类型
   - 检查时间戳格式
   - 确认单位设置

2. **调整面板配置**
   - 修改轴范围
   - 调整颜色映射
   - 更新显示格式

### 性能调优指南

#### 1. 数据库性能优化

```mermaid
graph TB
subgraph "PostgreSQL优化"
A[索引优化]
B[查询计划分析]
C[连接池配置]
D[统计信息更新]
end
subgraph "Prometheus优化"
A1[抓取间隔调整]
B1[标签优化]
C1[存储配置]
D1[查询优化]
end
A --> E[查询性能提升]
B --> E
C --> E
D --> E
A1 --> F[存储效率提升]
B1 --> F
C1 --> F
D1 --> F
```

#### 2. Grafana性能优化

| 优化项目 | 配置参数 | 推荐值 | 说明 |
|---------|---------|--------|------|
| 最大数据点 | maxDataPoints | 10000 | 控制内存使用 |
| 并发查询 | maxConcurrentQueries | 10 | 避免服务器过载 |
| 缓存设置 | cacheTimeout | 300 | 平衡实时性和性能 |
| 图表类型 | renderMode | svg | 提升渲染质量 |

### 监控告警配置

#### 1. 关键指标告警

```yaml
# Prometheus告警规则示例
groups:
  - name: transformers_monitoring
    rules:
      - alert: HighMemoryUsage
        expr: memory_usage_percent > 80
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High memory usage detected"
          
      - alert: HighLatency
        expr: avg_latency_seconds > 2
        for: 2m
        labels:
          severity: critical
        annotations:
          summary: "High latency detected"
```

#### 2. 通知配置

```yaml
# Alertmanager配置
receivers:
  - name: 'email-notifications'
    email_configs:
      - to: 'admin@company.com'
        from: 'alertmanager@company.com'
        
  - name: 'slack-notifications'
    slack_configs:
      - api_url: 'https://hooks.slack.com/services/YOUR/SLACK/WEBHOOK'

route:
  receiver: 'email-notifications'
  group_by: ['alertname']
  group_wait: 30s
  group_interval: 5m
  repeat_interval: 12h
```

## 总结

本指南详细介绍了transformers项目中Grafana仪表板的完整配置和使用方法。通过基准测试仪表板和连续批处理仪表板，用户可以全面监控模型推理性能和系统资源使用情况。

### 主要功能特性

1. **多维度监控**：涵盖性能指标、系统资源、业务指标等多个维度
2. **实时数据展示**：支持实时数据更新和历史数据分析
3. **灵活配置**：支持多种变量过滤和自定义面板
4. **集成式部署**：提供完整的Docker部署方案
5. **告警机制**：支持基于阈值的智能告警

### 最佳实践要点

1. **合理设置监控指标**：关注关键性能指标，避免过度监控
2. **优化查询性能**：定期审查和优化数据库查询
3. **建立告警机制**：设置合理的阈值和通知策略
4. **定期维护仪表板**：及时更新和优化面板配置
5. **成本控制**：平衡监控精度和系统成本

通过遵循本指南的配置和使用方法，用户可以充分发挥Grafana仪表板在transformers项目中的监控价值，实现高效、可靠的系统监控和性能优化。